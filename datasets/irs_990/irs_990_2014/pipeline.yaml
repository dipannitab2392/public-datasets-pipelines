# Copyright 2021 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
resources:

  - type: bigquery_table
    # Required Properties:
    table_id: irs_990_2014

    # Description of the table
    description: "irs_990 2014 dataset"

dag:
  initialize:
    dag_id: irs_990_2014
    default_args:
      owner: "Google"

      # When set to True, keeps a task from getting triggered if the previous schedule for the task hasnâ€™t succeeded
      depends_on_past: False
      start_date: '2021-03-01'
    max_active_runs: 1
    schedule_interval: "@daily"  # runs everyday at 7am EST
    catchup: False
    default_view: graph

  tasks:
    - operator: "KubernetesPodOperator"

      # Task description
      description: "Run CSV transform within kubernetes pod"

      args:

        task_id: "irs_990_transform_csv"

        startup_timeout_seconds: 600

        # The name of the pod in which the task will run. This will be used (plus a random suffix) to generate a pod id
        name: "irs_990_2014"

        # The namespace to run within Kubernetes. Always set its value to "default" because we follow the guideline that KubernetesPodOperator will only be used for very light workloads, i.e. use the Cloud Composer environment's resources without starving other pipelines.
        namespace: "default"

        image_pull_policy: "Always"

        # Docker images will be built and pushed to GCR by default whenever the `scripts/generate_dag.py` is run. To skip building and pushing images, use the optional `--skip-builds` flag.
        image: "{{ var.json.irs_990_irs_990_2014.container_registry.run_csv_transform_kub }}"

        # Set the environment variables you need initialized in the container. Use these as input variables for the script your container is expected to perform.
        env_vars:
          SOURCE_URL: "https://www.irs.gov/pub/irs-soi/14eofinextract990.zip"
          SOURCE_FILE: "files/data.dat"
          TARGET_FILE: "files/data_output.csv"
          TARGET_GCS_BUCKET: "{{ var.json.shared.composer_bucket }}"
          TARGET_GCS_PATH: "data/irs_990/irs_990_2014/data_output.csv"

        # Set resource limits for the pod here. For resource units in Kubernetes, see https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#resource-units-in-kubernetes
        resources:
          request_memory: "4G"
          request_cpu: "1"

    - operator: "GoogleCloudStorageToBigQueryOperator"
      description: "Task to load CSV data to a BigQuery table"

      args:
        task_id: "load_irs_990_to_bq"

        # The GCS bucket where the CSV file is located in.
        bucket: "{{ var.json.shared.composer_bucket }}"

        # The GCS object path for the CSV file
        source_objects: ["data/irs_990/irs_990_2014/data_output.csv"]
        source_format: "CSV"
        destination_project_dataset_table: "irs_990.irs_990_2014"

        # Use this if your CSV file contains a header row
        skip_leading_rows: 1

        # How to write data to the table: overwrite, append, or write if empty
        # See https://cloud.google.com/bigquery/docs/reference/auditlogs/rest/Shared.Types/WriteDisposition
        write_disposition: "WRITE_TRUNCATE"

        # The BigQuery table schema based on the CSV file. For more info, see
        # https://cloud.google.com/bigquery/docs/schemas.
        # Always use snake_case and lowercase for column names, and be explicit,
        # i.e. specify modes for all columns.
        schema_fields:
          - name : "ein"
            type : "string"
            mode : "required"
          - name : "tax_pd"
            type : "integer"
            mode : "nullable"
          - name : "subseccd"
            type : "integer"
            mode : "nullable"
          - name : "s501c3or4947a1cd"
            type : "string"
            mode : "nullable"
          - name : "schdbind"
            type : "string"
            mode : "nullable"
          - name : "politicalactvtscd"
            type : "string"
            mode : "nullable"
          - name : "lbbyingactvtscd"
            type : "string"
            mode : "nullable"
          - name : "subjto6033cd"
            type : "string"
            mode : "nullable"
          - name : "dnradvisedfundscd"
            type : "string"
            mode : "nullable"
          - name : "prptyintrcvdcd"
            type : "string"
            mode : "nullable"
          - name : "maintwrkofartcd"
            type : "string"
            mode : "nullable"
          - name : "crcounselingqstncd"
            type : "string"
            mode : "nullable"
          - name : "hldassetsintermpermcd"
            type : "string"
            mode : "nullable"
          - name : "rptlndbldgeqptcd"
            type : "string"
            mode : "nullable"
          - name : "rptinvstothsecd"
            type : "string"
            mode : "nullable"
          - name : "rptinvstprgrelcd"
            type : "string"
            mode : "nullable"
          - name : "rptothasstcd"
            type : "string"
            mode : "nullable"
          - name : "rptothliabcd"
            type : "string"
            mode : "nullable"
          - name : "sepcnsldtfinstmtcd"
            type : "string"
            mode : "nullable"
          - name : "sepindaudfinstmtcd"
            type : "string"
            mode : "nullable"
          - name : "inclinfinstmtcd"
            type : "string"
            mode : "nullable"
          - name : "operateschools170cd"
            type : "string"
            mode : "nullable"
          - name : "frgnofficecd"
            type : "string"
            mode : "nullable"
          - name : "frgnrevexpnscd"
            type : "string"
            mode : "nullable"
          - name : "frgngrntscd"
            type : "string"
            mode : "nullable"
          - name : "frgnaggragrntscd"
            type : "string"
            mode : "nullable"
          - name : "rptprofndrsngfeescd"
            type : "string"
            mode : "nullable"
          - name : "rptincfnndrsngcd"
            type : "string"
            mode : "nullable"
          - name : "rptincgamingcd"
            type : "string"
            mode : "nullable"
          - name : "operatehosptlcd"
            type : "string"
            mode : "nullable"
          - name : "hospaudfinstmtcd"
            type : "string"
            mode : "nullable"
          - name : "rptgrntstogovtcd"
            type : "string"
            mode : "nullable"
          - name : "rptgrntstoindvcd"
            type : "string"
            mode : "nullable"
          - name : "rptyestocompnstncd"
            type : "string"
            mode : "nullable"
          - name : "txexmptbndcd"
            type : "string"
            mode : "nullable"
          - name : "invstproceedscd"
            type : "string"
            mode : "nullable"
          - name : "maintescrwaccntcd"
            type : "string"
            mode : "nullable"
          - name : "actonbehalfcd"
            type : "string"
            mode : "nullable"
          - name : "engageexcessbnftcd"
            type : "string"
            mode : "nullable"
          - name : "awarexcessbnftcd"
            type : "string"
            mode : "nullable"
          - name : "loantofficercd"
            type : "string"
            mode : "nullable"
          - name : "grantoofficercd"
            type : "string"
            mode : "nullable"
          - name : "dirbusnreltdcd"
            type : "string"
            mode : "nullable"
          - name : "fmlybusnreltdcd"
            type : "string"
            mode : "nullable"
          - name : "servasofficercd"
            type : "string"
            mode : "nullable"
          - name : "recvnoncashcd"
            type : "string"
            mode : "nullable"
          - name : "recvartcd"
            type : "string"
            mode : "nullable"
          - name : "ceaseoperationscd"
            type : "string"
            mode : "nullable"
          - name : "sellorexchcd"
            type : "string"
            mode : "nullable"
          - name : "ownsepentcd"
            type : "string"
            mode : "nullable"
          - name : "reltdorgcd"
            type : "string"
            mode : "nullable"
          - name : "intincntrlcd"
            type : "string"
            mode : "nullable"
          - name : "orgtrnsfrcd"
            type : "string"
            mode : "nullable"
          - name : "conduct5percentcd"
            type : "string"
            mode : "nullable"
          - name : "compltschocd"
            type : "string"
            mode : "nullable"
          - name : "f1096cnt"
            type : "integer"
            mode : "nullable"
          - name : "fw2gcnt"
            type : "integer"
            mode : "nullable"
          - name : "wthldngrulescd"
            type : "string"
            mode : "nullable"
          - name : "noemplyeesw3cnt"
            type : "integer"
            mode : "nullable"
          - name : "filerqrdrtnscd"
            type : "string"
            mode : "nullable"
          - name : "unrelbusinccd"
            type : "string"
            mode : "nullable"
          - name : "filedf990tcd"
            type : "string"
            mode : "nullable"
          - name : "frgnacctcd"
            type : "string"
            mode : "nullable"
          - name : "prohibtdtxshltrcd"
            type : "string"
            mode : "nullable"
          - name : "prtynotifyorgcd"
            type : "string"
            mode : "nullable"
          - name : "filedf8886tcd"
            type : "string"
            mode : "nullable"
          - name : "solicitcntrbcd"
            type : "string"
            mode : "nullable"
          - name : "exprstmntcd"
            type : "string"
            mode : "nullable"
          - name : "providegoodscd"
            type : "string"
            mode : "nullable"
          - name : "notfydnrvalcd"
            type : "string"
            mode : "nullable"
          - name : "filedf8282cd"
            type : "string"
            mode : "nullable"
          - name : "f8282cnt"
            type : "integer"
            mode : "nullable"
          - name : "fndsrcvdcd"
            type : "string"
            mode : "nullable"
          - name : "premiumspaidcd"
            type : "string"
            mode : "nullable"
          - name : "filedf8899cd"
            type : "string"
            mode : "nullable"
          - name : "filedf1098ccd"
            type : "string"
            mode : "nullable"
          - name : "excbushldngscd"
            type : "string"
            mode : "nullable"
          - name : "s4966distribcd"
            type : "string"
            mode : "nullable"
          - name : "distribtodonorcd"
            type : "string"
            mode : "nullable"
          - name : "initiationfees"
            type : "integer"
            mode : "nullable"
          - name : "grsrcptspublicuse"
            type : "integer"
            mode : "nullable"
          - name : "grsincmembers"
            type : "integer"
            mode : "nullable"
          - name : "grsincother"
            type : "integer"
            mode : "nullable"
          - name : "filedlieuf1041cd"
            type : "string"
            mode : "nullable"
          - name : "txexmptint"
            type : "integer"
            mode : "nullable"
          - name : "qualhlthplncd"
            type : "string"
            mode : "nullable"
          - name : "qualhlthreqmntn"
            type : "integer"
            mode : "nullable"
          - name : "qualhlthonhnd"
            type : "integer"
            mode : "nullable"
          - name : "rcvdpdtngcd"
            type : "string"
            mode : "nullable"
          - name : "filedf720cd"
            type : "string"
            mode : "nullable"
          - name : "totreprtabled"
            type : "integer"
            mode : "nullable"
          - name : "totcomprelatede"
            type : "integer"
            mode : "nullable"
          - name : "totestcompf"
            type : "integer"
            mode : "nullable"
          - name : "noindiv100kcnt"
            type : "integer"
            mode : "nullable"
          - name : "nocontractor100kcnt"
            type : "integer"
            mode : "nullable"
          - name : "totcntrbgfts"
            type : "integer"
            mode : "nullable"
          - name : "prgmservcode2acd"
            type : "integer"
            mode : "nullable"
          - name : "totrev2acola"
            type : "integer"
            mode : "nullable"
          - name : "prgmservcode2bcd"
            type : "integer"
            mode : "nullable"
          - name : "totrev2bcola"
            type : "integer"
            mode : "nullable"
          - name : "prgmservcode2ccd"
            type : "integer"
            mode : "nullable"
          - name : "totrev2ccola"
            type : "integer"
            mode : "nullable"
          - name : "prgmservcode2dcd"
            type : "integer"
            mode : "nullable"
          - name : "totrev2dcola"
            type : "integer"
            mode : "nullable"
          - name : "prgmservcode2ecd"
            type : "integer"
            mode : "nullable"
          - name : "totrev2ecola"
            type : "integer"
            mode : "nullable"
          - name : "totrev2fcola"
            type : "integer"
            mode : "nullable"
          - name : "totprgmrevnue"
            type : "integer"
            mode : "nullable"
          - name : "invstmntinc"
            type : "integer"
            mode : "nullable"
          - name : "txexmptbndsproceeds"
            type : "integer"
            mode : "nullable"
          - name : "royaltsinc"
            type : "integer"
            mode : "nullable"
          - name : "grsrntsreal"
            type : "integer"
            mode : "nullable"
          - name : "grsrntsprsnl"
            type : "integer"
            mode : "nullable"
          - name : "rntlexpnsreal"
            type : "integer"
            mode : "nullable"
          - name : "rntlexpnsprsnl"
            type : "integer"
            mode : "nullable"
          - name : "rntlincreal"
            type : "integer"
            mode : "nullable"
          - name : "rntlincprsnl"
            type : "integer"
            mode : "nullable"
          - name : "netrntlinc"
            type : "integer"
            mode : "nullable"
          - name : "grsalesecur"
            type : "integer"
            mode : "nullable"
          - name : "grsalesothr"
            type : "integer"
            mode : "nullable"
          - name : "cstbasisecur"
            type : "integer"
            mode : "nullable"
          - name : "cstbasisothr"
            type : "integer"
            mode : "nullable"
          - name : "gnlsecur"
            type : "integer"
            mode : "nullable"
          - name : "gnlsothr"
            type : "integer"
            mode : "nullable"
          - name : "netgnls"
            type : "integer"
            mode : "nullable"
          - name : "grsincfndrsng"
            type : "integer"
            mode : "nullable"
          - name : "lessdirfndrsng"
            type : "integer"
            mode : "nullable"
          - name : "netincfndrsng"
            type : "integer"
            mode : "nullable"
          - name : "grsincgaming"
            type : "integer"
            mode : "nullable"
          - name : "lessdirgaming"
            type : "integer"
            mode : "nullable"
          - name : "netincgaming"
            type : "integer"
            mode : "nullable"
          - name : "grsalesinvent"
            type : "integer"
            mode : "nullable"
          - name : "lesscstofgoods"
            type : "integer"
            mode : "nullable"
          - name : "netincsales"
            type : "integer"
            mode : "nullable"
          - name : "miscrev11acd"
            type : "integer"
            mode : "nullable"
          - name : "miscrevtota"
            type : "integer"
            mode : "nullable"
          - name : "miscrev11bcd"
            type : "integer"
            mode : "nullable"
          - name : "miscrevtot11b"
            type : "integer"
            mode : "nullable"
          - name : "miscrev11ccd"
            type : "integer"
            mode : "nullable"
          - name : "miscrevtot11c"
            type : "integer"
            mode : "nullable"
          - name : "miscrevtot11d"
            type : "integer"
            mode : "nullable"
          - name : "miscrevtot11e"
            type : "integer"
            mode : "nullable"
          - name : "totrevenue"
            type : "integer"
            mode : "nullable"
          - name : "grntstogovt"
            type : "integer"
            mode : "nullable"
          - name : "grnsttoindiv"
            type : "integer"
            mode : "nullable"
          - name : "grntstofrgngovt"
            type : "integer"
            mode : "nullable"
          - name : "benifitsmembrs"
            type : "integer"
            mode : "nullable"
          - name : "compnsatncurrofcr"
            type : "integer"
            mode : "nullable"
          - name : "compnsatnandothr"
            type : "integer"
            mode : "nullable"
          - name : "othrsalwages"
            type : "integer"
            mode : "nullable"
          - name : "pensionplancontrb"
            type : "integer"
            mode : "nullable"
          - name : "othremplyeebenef"
            type : "integer"
            mode : "nullable"
          - name : "payrolltx"
            type : "integer"
            mode : "nullable"
          - name : "feesforsrvcmgmt"
            type : "integer"
            mode : "nullable"
          - name : "legalfees"
            type : "integer"
            mode : "nullable"
          - name : "accntingfees"
            type : "integer"
            mode : "nullable"
          - name : "feesforsrvclobby"
            type : "integer"
            mode : "nullable"
          - name : "profndraising"
            type : "integer"
            mode : "nullable"
          - name : "feesforsrvcinvstmgmt"
            type : "integer"
            mode : "nullable"
          - name : "feesforsrvcothr"
            type : "integer"
            mode : "nullable"
          - name : "advrtpromo"
            type : "integer"
            mode : "nullable"
          - name : "officexpns"
            type : "integer"
            mode : "nullable"
          - name : "infotech"
            type : "integer"
            mode : "nullable"
          - name : "royaltsexpns"
            type : "integer"
            mode : "nullable"
          - name : "occupancy"
            type : "integer"
            mode : "nullable"
          - name : "travel"
            type : "integer"
            mode : "nullable"
          - name : "travelofpublicoffcl"
            type : "integer"
            mode : "nullable"
          - name : "converconventmtng"
            type : "integer"
            mode : "nullable"
          - name : "interestamt"
            type : "integer"
            mode : "nullable"
          - name : "pymtoaffiliates"
            type : "integer"
            mode : "nullable"
          - name : "deprcatndepletn"
            type : "integer"
            mode : "nullable"
          - name : "insurance"
            type : "integer"
            mode : "nullable"
          - name : "othrexpnsa"
            type : "integer"
            mode : "nullable"
          - name : "othrexpnsb"
            type : "integer"
            mode : "nullable"
          - name : "othrexpnsc"
            type : "integer"
            mode : "nullable"
          - name : "othrexpnsd"
            type : "integer"
            mode : "nullable"
          - name : "othrexpnse"
            type : "integer"
            mode : "nullable"
          - name : "othrexpnsf"
            type : "integer"
            mode : "nullable"
          - name : "totfuncexpns"
            type : "integer"
            mode : "nullable"
          - name : "nonintcashend"
            type : "integer"
            mode : "nullable"
          - name : "svngstempinvend"
            type : "integer"
            mode : "nullable"
          - name : "pldgegrntrcvblend"
            type : "integer"
            mode : "nullable"
          - name : "accntsrcvblend"
            type : "integer"
            mode : "nullable"
          - name : "currfrmrcvblend"
            type : "integer"
            mode : "nullable"
          - name : "rcvbldisqualend"
            type : "integer"
            mode : "nullable"
          - name : "notesloansrcvblend"
            type : "integer"
            mode : "nullable"
          - name : "invntriesalesend"
            type : "integer"
            mode : "nullable"
          - name : "prepaidexpnsend"
            type : "integer"
            mode : "nullable"
          - name : "lndbldgsequipend"
            type : "integer"
            mode : "nullable"
          - name : "invstmntsend"
            type : "integer"
            mode : "nullable"
          - name : "invstmntsothrend"
            type : "integer"
            mode : "nullable"
          - name : "invstmntsprgmend"
            type : "integer"
            mode : "nullable"
          - name : "intangibleassetsend"
            type : "integer"
            mode : "nullable"
          - name : "othrassetsend"
            type : "integer"
            mode : "nullable"
          - name : "totassetsend"
            type : "integer"
            mode : "nullable"
          - name : "accntspayableend"
            type : "integer"
            mode : "nullable"
          - name : "grntspayableend"
            type : "integer"
            mode : "nullable"
          - name : "deferedrevnuend"
            type : "integer"
            mode : "nullable"
          - name : "txexmptbndsend"
            type : "integer"
            mode : "nullable"
          - name : "escrwaccntliabend"
            type : "integer"
            mode : "nullable"
          - name : "paybletoffcrsend"
            type : "integer"
            mode : "nullable"
          - name : "secrdmrtgsend"
            type : "integer"
            mode : "nullable"
          - name : "unsecurednotesend"
            type : "integer"
            mode : "nullable"
          - name : "othrliabend"
            type : "integer"
            mode : "nullable"
          - name : "totliabend"
            type : "integer"
            mode : "nullable"
          - name : "unrstrctnetasstsend"
            type : "integer"
            mode : "nullable"
          - name : "temprstrctnetasstsend"
            type : "integer"
            mode : "nullable"
          - name : "permrstrctnetasstsend"
            type : "integer"
            mode : "nullable"
          - name : "capitalstktrstend"
            type : "integer"
            mode : "nullable"
          - name : "paidinsurplusend"
            type : "integer"
            mode : "nullable"
          - name : "retainedearnend"
            type : "integer"
            mode : "nullable"
          - name : "totnetassetend"
            type : "integer"
            mode : "nullable"
          - name : "totnetliabastend"
            type : "integer"
            mode : "nullable"
          - name : "nonpfrea"
            type : "integer"
            mode : "nullable"
          - name : "totnooforgscnt"
            type : "integer"
            mode : "nullable"
          - name : "totsupport"
            type : "integer"
            mode : "nullable"
          - name : "gftgrntsrcvd170"
            type : "integer"
            mode : "nullable"
          - name : "txrevnuelevied170"
            type : "integer"
            mode : "nullable"
          - name : "srvcsval170"
            type : "integer"
            mode : "nullable"
          - name : "pubsuppsubtot170"
            type : "integer"
            mode : "nullable"
          - name : "exceeds2pct170"
            type : "integer"
            mode : "nullable"
          - name : "pubsupplesspct170"
            type : "integer"
            mode : "nullable"
          - name : "samepubsuppsubtot170"
            type : "integer"
            mode : "nullable"
          - name : "grsinc170"
            type : "integer"
            mode : "nullable"
          - name : "netincunreltd170"
            type : "integer"
            mode : "nullable"
          - name : "othrinc170"
            type : "integer"
            mode : "nullable"
          - name : "totsupp170"
            type : "integer"
            mode : "nullable"
          - name : "grsrcptsrelated170"
            type : "integer"
            mode : "nullable"
          - name : "totgftgrntrcvd509"
            type : "integer"
            mode : "nullable"
          - name : "grsrcptsadmissn509"
            type : "integer"
            mode : "nullable"
          - name : "grsrcptsactivities509"
            type : "integer"
            mode : "nullable"
          - name : "txrevnuelevied509"
            type : "integer"
            mode : "nullable"
          - name : "srvcsval509"
            type : "integer"
            mode : "nullable"
          - name : "pubsuppsubtot509"
            type : "integer"
            mode : "nullable"
          - name : "rcvdfrmdisqualsub509"
            type : "integer"
            mode : "nullable"
          - name : "exceeds1pct509"
            type : "integer"
            mode : "nullable"
          - name : "subtotpub509"
            type : "integer"
            mode : "nullable"
          - name : "pubsupplesub509"
            type : "integer"
            mode : "nullable"
          - name : "samepubsuppsubtot509"
            type : "integer"
            mode : "nullable"
          - name : "grsinc509"
            type : "integer"
            mode : "nullable"
          - name : "unreltxincls511tx509"
            type : "integer"
            mode : "nullable"
          - name : "subtotsuppinc509"
            type : "integer"
            mode : "nullable"
          - name : "netincunrelatd509"
            type : "integer"
            mode : "nullable"
          - name : "othrinc509"
            type : "integer"
            mode : "nullable"
          - name : "totsupp509"
            type : "integer"
            mode : "nullable"

  graph_paths:
    - "irs_990_transform_csv >> load_irs_990_to_bq"